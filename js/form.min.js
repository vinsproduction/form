var Form;Form=function(){function Form(options){var k,ref,v;this.options=null!=options?options:{},ref=this.options;for(k in ref)v=ref[k],this[k]=v;this.errorTemplate='<div class="'+this.errorAlertClass+'"></div>',this.errorTemplateList="{error}<br/>",$(function(_this){return function(){return _this.formEl?_this.submitEl?(_this.form=_this.isObject(_this.formEl)?_this.formEl:$(_this.formEl),_this.submitBtn=_this.isObject(_this.submitEl)?_this.submitEl:_this.form.find(_this.submitEl),_this.form.size()?_this.submitBtn.size()?(_this.init(),_this.log("onLoad","options",_this.options),_this.onLoad()):_this.log("Warning! submitEl not found in DOM"):_this.log("Warning! formEl not found in DOM")):_this.log("Warning! submitEl not set"):_this.log("Warning! formEl not set")}}(this))}return Form.prototype.logs=!1,Form.prototype.formName=!1,Form.prototype.formEl=!1,Form.prototype.submitEl=!1,Form.prototype.autoHideErrors=!1,Form.prototype.errorAlertClass="error-alert",Form.prototype.errorAlertExtClass="error",Form.prototype.errorInputClass="error-field",Form.prototype.placeholderClass="placeholder",Form.prototype.errorHideMethod="display",Form.prototype.errorFadeIn=300,Form.prototype.errorFadeOut=800,Form.prototype.fields={},Form.prototype.data={},Form.prototype.errors={},Form.prototype.onFail=function(errors){},Form.prototype.onSuccess=function(data){},Form.prototype.onSubmit=function(data){},Form.prototype.onReset=function(){},Form.prototype.onLoad=function(){},Form.prototype.onInit=function(){},Form.prototype.init=function(){var el,errorAlert,name,ref,ref1,ref2,ref3,ref4,ref5,self;self=this,this.form.unbind(),this.submitBtn.unbind();for(name in this.fields)el=this.form.find("[name='"+name+"']").eq(0),el.unbind(),"checkbox"===(ref=el.attr("type"))||"radio"===ref?this.fields[name].originVal=el.filter(":checked").val()||!1:this.fields[name].originVal=el.val(),this.fields[name].style=null!=(ref1=this.fields[name].style)?ref1:!1,this.fields[name].useErrorTemplate=null!=(ref2=this.fields[name].useErrorTemplate)?ref2:!1,this.fields[name].hideErrorsOnFocus=null!=(ref3=this.fields[name].hideErrorsOnFocus)?ref3:!1,this.fields[name].checkErrorsOnFocus=null!=(ref4=this.fields[name].checkErrorsOnFocus)?ref4:!1,this.fields[name].focus=null!=(ref5=this.fields[name].focus)?ref5:!1,this.fields[name].onError||(this.fields[name].onError=function(fieldName,errors){}),this.fields[name].placeholder&&(el.is("input[type='text']")||el.is("textarea"))&&this.placeholder(el,this.fields[name].placeholder),this.fields[name].enterSubmit&&el.keydown(function(_this){return function(event){return 13===event.keyCode?_this.submit():void 0}}(this)),this.fields[name].useErrorTemplate&&this.fields[name].rules&&(errorAlert=$("."+this.errorAlertExtClass+"-"+name),errorAlert.size()||(errorAlert=$(this.errorTemplate),errorAlert.addClass(this.errorAlertExtClass+"-"+name),el.after(errorAlert)),errorAlert.unbind(),"visibility"===this.errorHideMethod?errorAlert.css("visibility","hidden").show():errorAlert.hide(),this.fields[name].hideErrorsOnFocus&&el.focus(function(){return el=$(this),name=el.attr("name"),self.removeErrorAlert(name)}),this.fields[name].checkErrorsOnFocus&&el.keyup(function(){var ref6,rule,ruleName,val,valid;self.errors[name]=[],self.data[name]=[],el=$(this),name=el.attr("name"),val=self.getVal(name),self.setData(name,val),self.removeErrorAlert(name),ref6=self.fields[name].rules;for(ruleName in ref6)rule=ref6[ruleName],valid=self.validate[ruleName](val,rule),valid.state||self.setError(name,valid.reason);return self.isEmpty(self.errors[name])?void 0:(self.log("onError",name,self.errors[name]),self.addErrorAlert(name),self.fields[name].onError(name,self.errors[name]))})),this.fields[name].style&&el.is("select")&&(this.createSelect(el),el.change(function(_this){return function(){return _this.createSelect(el)}}(this))),this.fields[name].style&&"radio"===el.attr("type")&&self.createRadio(name),this.fields[name].style&&"checkbox"===el.attr("type")&&self.createCheckbox(name),this.fields[name].focus&&el.focus();return this.form.submit(function(e){return e.preventDefault()}),this.submitBtn.click(function(_this){return function(){return _this.submit(),!1}}(this)),this.onInit()},Form.prototype.createCheckbox=function(name){var $checkbox,el,self,value;return el=this.form.find("[name='"+name+"']"),el.hide(),name=el.attr("name"),value=el.attr("value"),self=this,this.form.find(".checkbox[data-name="+name+"][data-value="+value+"]").size()&&this.form.find(".checkbox[data-name="+name+"][data-value="+value+"]").remove(),el.click(function(){return $(this).is(":checked")?self.form.find(".checkbox[data-name="+name+"]").addClass("checked"):self.form.find(".checkbox[data-name="+name+"]").removeClass("checked")}),$checkbox=$("<div class='checkbox' data-name='"+name+"' data-value='"+value+"'></div>"),el.attr("checked")&&$checkbox.addClass("checked"),el.after($checkbox),$checkbox.click(function(){return $(this).hasClass("checked")?($(this).removeClass("checked"),self.setVal(name,!1)):($(this).addClass("checked"),self.setVal(name,value))})},Form.prototype.createRadio=function(name){var $radioEl,self;return $radioEl=this.form.find("[name='"+name+"']"),self=this,$radioEl.each(function(){var $radio,el,value;return el=$(this),el.hide(),name=el.attr("name"),value=el.attr("value"),self.form.find(".radio[data-name="+name+"][data-value="+value+"]").size()&&self.form.find(".radio[data-name="+name+"][data-value="+value+"]").remove(),el.click(function(){return self.form.find(".radio[data-name="+name+"]").removeClass("checked"),self.form.find(".radio[data-name="+name+"][data-value="+value+"]").addClass("checked")}),$radio=$("<div class='radio' data-name='"+name+"' data-value='"+value+"'></div>"),el.attr("checked")&&$radio.addClass("checked"),el.after($radio),$radio.click(function(){return self.form.find(".radio[data-name="+name+"]").removeClass("checked"),$(this).addClass("checked"),self.setVal(name,value)})})},Form.prototype.createSelect=function(el){var $options,$select,$selected,name,selectClose,selectedText,self;return el.hide(),name=el.attr("name"),self=this,this.form.find(".select[data-name='"+name+"']").size()&&this.form.find(".select[data-name='"+name+"']").remove(),$select=$("<div class='select' data-name='"+name+"'></div>"),$options=$("<div class='options' style='display:none;'></div>"),selectedText=el.find("option[selected]").size()?el.find("option:selected").text():el.find("option:first-child").text(),$selected=$("<div class='selected default'>"+selectedText+"</div>"),$select.append($selected),$select.append($options),el.after($select),selectClose=!1,$select.mouseover(function(){return selectClose=!1}),$select.mouseout(function(){return selectClose=!0}),$(document).click(function(){return selectClose?($select.removeClass("open"),$options.hide()):void 0}),$selected.click(function(){return $select.hasClass("open")?($select.removeClass("open"),$options.hide()):($select.addClass("open"),$options.show())}),el.find("option").each(function(){var $option;return $option=$(this).attr("value")?$("<div class='option' data-value='"+$(this).attr("value")+"'><span>"+$(this).text()+"</span></div>"):$("<div class='option'><span>"+$(this).text()+"</span></div>"),$option.click(function(_this){return function(){return $(_this).attr("value")?(self.setVal(name,$(_this).attr("value")),$selected.removeClass("default")):(self.setVal(name,self.fields[name].originVal),$selected.addClass("default")),$select.find(".selected").html($(_this).text()),$select.removeClass("open"),$options.hide()}}(this)),$options.append($option)})},Form.prototype.setVal=function(name,val){var el,ref;return el=this.form.find("[name='"+name+"']"),"checkbox"===(ref=el.attr("type"))||"radio"===ref?(el.prop("checked",!1),el.filter("[value='"+val+"']").prop("checked",!0)):el.val(this.trim(val)),this.fields[name].placeholder&&(el.is("input[type='text']")||el.is("textarea"))&&(""===val||val===this.fields[name].placeholder?this.placeholder(el,this.fields[name].placeholder):el.removeClass(this.placeholderClass)),this.fields[name].useErrorTemplate?this.removeErrorAlert(name):void 0},Form.prototype.getVal=function(name){var el,ref,val;return el=this.form.find("[name='"+name+"']"),name=el.attr("name"),"checkbox"===(ref=el.attr("type"))||"radio"===ref?val=el.filter(":checked").val()||!1:el.is("select")?val=el.val():(el.val(this.trim(el.val())),this.fields[name].escape&&el.val(this.stripHTML(el.val())),val=this.trim(el.val()),this.fields[name].placeholder&&val===this.fields[name].placeholder&&(val="")),val},Form.prototype.submit=function(){var name,ref,rule,ruleName,val,valid;this.log("SUBMIT!"),this.resetData(),this.resetErorrs();for(name in this.fields)if(val=this.getVal(name),this.setData(name,val),this.removeErrorAlert(name),this.fields[name].rules){ref=this.fields[name].rules;for(ruleName in ref)rule=ref[ruleName],valid=this.validate[ruleName](val,rule),valid.state||this.setError(name,valid.reason)}return this.log("onSubmit","data",this.data),this.onSubmit(this.data),this.isEmpty(this.errors)?this.success():this.fail()},Form.prototype.fail=function(){var field,name,ref;ref=this.fields;for(name in ref)field=ref[name],this.errors[name]&&(this.log("onError",name,this.errors[name]),this.addErrorAlert(name),this.fields[name].onError(name,this.errors[name]));return this.autoHideErrors&&setTimeout(function(_this){return function(){var ref1,results;ref1=_this.fields,results=[];for(name in ref1)field=ref1[name],results.push(_this.removeErrorAlert(name));return results}}(this),1e3),this.log("onFail","errors",this.errors),this.onFail(this.errors)},Form.prototype.success=function(){return this.log("onSuccess","data",this.data),this.onSuccess(this.data)},Form.prototype.reset=function(){var name;this.resetData(),this.resetErorrs();for(name in this.fields)this.setVal(name,this.fields[name].originVal);return this.log("onReset"),this.onReset(),this.init(),!1},Form.prototype.resetErorrs=function(){return this.errors={}},Form.prototype.resetData=function(){return this.data={}},Form.prototype.setData=function(name,val){return this.data[name]?void 0:this.data[name]=val},Form.prototype.setError=function(name,val){return this.errors[name]||(this.errors[name]=[]),this.errors[name].push(val)},Form.prototype.addErrorAlert=function(name){var el,errorAlert,i;if(this.fields[name].useErrorTemplate){el=this.form.find("[name='"+name+"']"),el.addClass(this.errorInputClass),el.is("select")&&this.fields[name].style&&this.form.find(".select[data-name='"+name+"']").addClass(this.errorInputClass),errorAlert=this.form.find("."+this.errorAlertExtClass+"-"+name),errorAlert.stop().empty();for(i in this.errors[name])errorAlert.append(this.errorTemplateList.replace(/\{error\}/g,this.errors[name][i]));if("visibility"===this.errorHideMethod&&errorAlert.css("visibility","visible"),this.errorFadeIn)return errorAlert.hide().fadeIn(this.errorFadeIn)}},Form.prototype.removeErrorAlert=function(name){var el,errorAlert;return this.fields[name].useErrorTemplate?(el=this.form.find("[name='"+name+"']"),el.removeClass(this.errorInputClass),el.is("select")&&this.fields[name].style&&this.form.find(".select[data-name='"+name+"']").removeClass(this.errorInputClass),errorAlert=this.form.find("."+this.errorAlertExtClass+"-"+name),"visibility"===this.errorHideMethod?(errorAlert.css("visibility","hidden").show(),errorAlert.empty()):this.errorFadeOut?errorAlert.stop().css({opacity:"1"}).fadeOut(this.errorFadeOut,function(){return errorAlert.empty()}):(errorAlert.empty(),errorAlert.hide())):void 0},Form.prototype.placeholder=function(el,val){return el.focus(function(_this){return function(){return el.val()===val?el.val("").removeClass(_this.placeholderClass):void 0}}(this)).blur(function(_this){return function(){return""===el.val()?el.val(val).addClass(_this.placeholderClass):void 0}}(this)),el.blur()},Form.prototype.validate={required:function(val,rule){var valid;return valid={state:""!==val&&val!==!1&&val!==rule.not,reason:rule.reason||"Не заполнено"}},numeric:function(val,rule){var valid;return valid={state:/^[0-9]+$/.test(val)||""===val,reason:rule.reason||"Не цифры"}},numericDash:function(val,rule){var valid;return valid={state:/^[\d\-\s]+$/.test(val)||""===val,reason:rule.reason||"Не цифры и подчеркивания"}},alpha:function(val,rule){var valid;return valid={state:/^[a-zа-я]+$/i.test(val)||""===val,reason:rule.reason||"Не буквы"}},alphaDash:function(val,rule){var valid;return valid={state:/^[a-z0-9_\-]+$/i.test(val)||""===val,reason:rule.reason||"Не буквы и подчеркивания"}},alphaNumeric:function(val,rule){var valid;return valid={state:/^[a-z0-9]+$/i.test(val)||""===val,reason:rule.reason||"Не буквы и не цифры"}},max:function(val,rule){var valid;return rule.reason&&(rule.reason=rule.reason.replace(/\{count\}/g,rule.count)),valid={state:val.length<=rule.count||""===val,reason:rule.reason||"Максимум "+rule.count}},min:function(val,rule){var valid;return rule.reason&&(rule.reason=rule.reason.replace(/\{count\}/g,rule.count)),valid={state:val.length>=rule.count||""===val,reason:rule.reason||"Минимум "+rule.count}},email:function(val,rule){var valid;return valid={state:/^[a-zA-Z0-9.!#$%&amp;'*+\-\/=?\^_`{|}~\-]+@[a-zA-Z0-9\-]+(?:\.[a-zA-Z0-9\-]+)*$/.test(val)||""===val,reason:rule.reason||"Не email"}},url:function(val,rule){var valid;return valid={state:/^((http|https):\/\/(\w+:{0,1}\w*@)?(\S+)|)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?$/.test(val)||""===val,reason:rule.reason||"Не url"}},ip:function(val,rule){var valid;return valid={state:/^((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){3}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})$/i.test(val)||""===val,reason:rule.reason||"Не ip"}}},Form.prototype.addRule=function(opt){return this.fields[opt.field].rules[opt.rule]=opt.reason,this.validate[opt.rule]=function(val,args,description){var valid;return valid={state:opt.condition(val)||""===val,reason:opt.reason||"custom reason"}}},Form.prototype.log=function(){var argument,formName,j,len,newArgs;if(console&&this.logs){for(formName=this.formName||this.formEl,newArgs=["[Form]","'"+formName+"'"],j=0,len=arguments.length;len>j;j++)argument=arguments[j],newArgs.push(argument);return console.log.apply(console,newArgs)}},Form.prototype.trim=function(text){return null==text&&(text=""),text.replace(/^\s+|\s+$/g,"")},Form.prototype.stripHTML=function(text){return null==text&&(text=""),text.replace(/<(?:.|\s)*?>/g,"")},Form.prototype.isFunction=function(obj){return"[object Function]"===Object.prototype.toString.call(obj)},Form.prototype.isString=function(obj){return"[object String]"===Object.prototype.toString.call(obj)},Form.prototype.isArray=function(obj){return"[object Array]"===Object.prototype.toString.call(obj)},Form.prototype.isObject=function(obj){return"[object Object]"===Object.prototype.toString.call(obj)},Form.prototype.isEmpty=function(o){var i;if(this.isString(o))return""===this.trim(o)?!0:!1;if(this.isArray(o))return 0===o.length?!0:!1;if(this.isObject(o)){for(i in o)if(o.hasOwnProperty(i))return!1;return!0}},Form.prototype.declOfNum=function(number,titles){var cases;return cases=[2,0,1,1,1,2],titles[number%100>4&&20>number%100?2:cases[5>number%10?number%10:5]]},Form}();